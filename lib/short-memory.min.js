/* short-memory; Copyright 2012 Aejay Goehring. Licensed under MIT License; See LICENSE for details. */
(function(){var e,t,o,n,r,l;!Function.prototype.bind||typeof console!="object"&&typeof console!="function"||typeof console.log!="object"||["log","info","warn","error","assert","dir","clear","profile","profileEnd"].forEach(function(e){return console[e]=this.call(console[e],console)},Function.prototype.bind),r=r||global,r.log||(r.log=function(){var e,t;return log.history=log.history||[],log.history.push(arguments_),typeof console!="undefined"&&typeof console.log=="function"?Array.prototype.slice.call(arguments_).length===1&&typeof Array.prototype.slice.call(arguments_)[0]=="string"?console.log(Array.prototype.slice.call(arguments_)+""):console.log(Array.prototype.slice.call(arguments_)):Function.prototype.bind||typeof console=="undefined"||typeof console.log!="object"?(e=arguments_,document.getElementById("firebug-lite")?setTimeout(function(){return r.log.apply(r,e)},500):(t=document.createElement("script"),t.type="text/javascript",t.id="firebug-lite",t.src="https://getfirebug.com/firebug-lite.js",document.getElementsByTagName("HEAD")[0].appendChild(t),setTimeout(function(){return r.log.apply(r,e)},2e3))):Function.prototype.call.call(console.log,console,Array.prototype.slice.call(arguments_))}),Object.keys=Object.keys||function(){var e,t,o,n;return n=Object.prototype.hasOwnProperty,o=!{toString:null}.propertyIsEnumerable("toString"),e=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],t=e.length,function(t){var r,l,i,u,a,c;if(typeof t!="object"&&typeof t!="function"||t===null)throw new TypeError("Object.keys called on a non-object");u=[];for(l in t)i=t[l],n.call(t,l)&&u.push(l);if(o)for(a=0,c=e.length;c>a;a++)r=e[a],n.call(t,r)&&u.push(r);return u}}(),(l=this.process)==null&&(this.process={}),this.process.nextTick||(this.process.nextTick=function(e){return setTimeout(e,0)}),t=function(){function t(e){var n,r,l,i,u,a;o=this,e==null&&(e={}),(n=e.maxSize)==null&&(e.maxSize=0),(r=e.maxCount)==null&&(e.maxCount=0),(l=e.maxAge)==null&&(e.maxAge=0),(i=e.deathTime)==null&&(e.deathTime=0),(u=e.pruneTime)==null&&(e.pruneTime=5),(a=e.debug)==null&&(e.debug=!1),o.maxSize=e.maxSize,o.maxCount=e.maxCount,o.maxAge=e.maxAge,o.debug=e.debug,o.pruneTime=e.pruneTime*1e3,o.deathTime=e.deathTime,function(e){return t.prototype.prune.call(e)}(o)}var o;return t.prototype.heap={},t.prototype.maxSize=0,t.prototype.maxCount=0,t.prototype.maxAge=0,t.prototype.pruneTime=5,t.prototype.deathTime=0,t.prototype.debug=!1,o=t,t.prototype.set=function(e,t,n,r){return typeof n=="function"&&(r=n,n={}),typeof r=="function"?(o.debug&&console.log("Debug: set has a callback; running async"),process.nextTick(function(){var l;return l=o.setInternal(e,t,n),r(l[0],l[1])}),null):(o.debug&&console.log("Debug: get has no callback; running sync"),o.setInternal(e,t,n)[1])},t.prototype.setInternal=function(t,n,r){var l,i,u;try{return r==null&&(r={}),(i=r.maxAge)==null&&(r.maxAge=o.maxAge),(u=r.deathTime)==null&&(r.deathTime=o.deathTime),l=new e(t,n,r),o.heap[t]=l,o.debug&&console.log("Debug: set heap["+t+"] to "+n),[null,l.data]}catch(a){return console.error("Unable to set memorable: "+a),[{type:"exception",message:a},null]}},t.prototype.get=function(e,t){return o=this,typeof t=="function"?(o.debug&&console.log("Debug: get has a callback; running async"),process.nextTick(function(){var n;return n=o.getInternal(e),t(n[0],n[1])}),null):(o.debug&&console.log("Debug: get has no callback; running sync"),o.getInternal(e)[1])},t.prototype.getInternal=function(e){var t;return o.debug&&console.log("Debug: getting key "+e+" from heap"),t=o.heap[e],t===void 0?(o.debug&&console.log("Debug: not found"),[{type:"notfound",message:"Key "+e+" not found in heap."},null]):t.isGood?(o.debug&&console.log("Debug: found it!"),[null,t.data]):(o.debug&&console.log("Debug: expired or invalid"),o.destroy(e),[{type:"notvalid",message:"Key "+e+" expired or invalid."},null])},t.prototype.getOrSet=function(e,t,n,r){var l;if(o=this,typeof n=="function"&&(r=n,n={}),typeof r!="function"){if(o.debug&&console.log("Debug: getOrSet; getting sync"),l=o.getInternal(e),l[0]){if(o.debug&&console.log("Debug: getOrSet; no valid key; setting"),n.async)throw"Cannot call getOrSet async without a callback!";return o.setInternal(e,t(),n)}if(o.heap[e].isNearDeath()){if(o.debug&&console.log("Debug: getOrSet; key is near death; will set after get"),n.async)throw"Cannot call getOrSet async without a callback!";process.nextTick(function(){return o.set(e,t(e,n))})}return l[1]}return o.debug&&console.log("Debug: getOrSet; getting async"),o.get(e,function(l,i){return l?(o.debug&&console.log("Debug: getOrSet; key invalid, setting back"),n.async?(o.debug&&console.log("Debug: getOrSet; setback is async"),t(e,function(t){return o.set(e,t,n,r)})):(o.debug&&console.log("Debug: getOrSet; setback is sync"),o.set(e,t(e),n,r))):(o.debug&&console.log("Debug: getOrSet; key exists, calling back"),r(null,i),o.heap[e].isNearDeath()?(o.debug&&console.log("Debug: getOrSet; key is near death; will set after get"),n.async?process.nextTick(function(){return t(e,function(t){return o.set(e,t,n)})}):process.nextTick(function(){return o.set(e,t(e,n))})):void 0)}),o.get(e,function(l,i){var u;return l?l.type==="notfound"||l.type==="invalid"?(u=t(),o.set(e,u,n,r)):r(l):r(null,i)})},t.prototype.destroy=function(e,t){return typeof t=="function"?process.nextTick(function(){return o.debug&&console.log("Debug: destroying key sync "+e),t(delete o.heap[e])}):(o.debug&&console.log("Debug: destroying key sync "+e),delete o.heap[e])},t.prototype.prune=function(){var e,n,r,l,i,u,a,c,s,p,g,y,f,d,m,h;clearTimeout(o.timer),u=[],a=0,m=o.heap;for(n in m)r=m[n],r.isGood()||u.push(n);for(s=0,y=u.length;y>s;s++)n=u[s],a++,o.destroy(n);if(o.maxCount!==0&&(e=Object.keys(o.heap).length,e>o.maxCount))for(l=e-o.maxCount,u=Object.keys(o.heap).slice(0,l),p=0,f=u.length;f>p;p++)n=u[p],a++,o.destroy(n);if(o.maxSize!==0&&(c=o.calculateSize(),c>o.maxSize)){i=c-o.maxSize,u=[],h=o.heap;for(n in h)if(r=h[n],u.push(n),i-=r.size,0>=i)break;for(g=0,d=u.length;d>g;g++)n=u[g],a++,o.destroy(n)}return o.timer=setTimeout(function(){return t.prototype.prune.call(o)},o.pruneTime),a},t.prototype.calculateSize=function(){var e,t,n,r;n=0,r=o.heap;for(e in r)t=r[e],n+=t.size;return n},t.prototype.isHealthy=function(e){var t;return t=o.heap[e],t?t.isGood()&&!t.isNearDeath():!1},t}(),e=function(){function e(e,o,n){var r,l;if(t=this,e===void 0)throw"Memorable missing key element";if(o===void 0)throw"Memorable missing data element";n==null&&(n={}),(r=n.maxAge)==null&&(n.maxAge=0),(l=n.deathTime)==null&&(n.deathTime=0),t.key=e,t.data=o,n.maxAge!==0&&(t.expires=Date.now()+n.maxAge*1e3),t.deathTime=n.deathTime,t.size=t.calculateSize()}var t;return e.prototype.key="",e.prototype.data={},e.prototype.invalid=!1,e.prototype.size=0,e.prototype.expires=0,e.prototype.deathTime=0,t=e,e.prototype.isGood=function(){return!t.invalid&&(t.expires===0||t.expires>Date.now())},e.prototype.isNearDeath=function(){return Date.now()>t.expires-t.deathTime*1e3},e.prototype.invalidate=function(){return t.invalid=!0},e.prototype.calculateSize=function(){var e,o,n,r,l,i,u,a;n=[],i=[t.data],e=0,r=null,l=function(e){return e.__c||!1},o=function(e){return e.__c=!0},u=function(e){return delete e.__c};while(i.length)a=i.pop(),function(t){var r,a;if(typeof t=="string")return e+=t.length*2;if(typeof t=="boolean")return e+=4;if(typeof t=="number")return e+=8;if(typeof t=="object"&&!l(t)){n.push(function(){return u(t)});for(r in t)a=t[r],t.hasOwnProperty(r)&&i.push(a);return o(t)}}(a);while(r=n.pop())r.call();return e},e}(),n=this,o=!1,typeof module!="undefined"&&module.exports&&(module.exports=t),n.ShortMemory=t,n.Memorable=e}).call(this)