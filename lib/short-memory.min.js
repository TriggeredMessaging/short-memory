(function(){var e,t,n,o,r;Object.keys=Object.keys||function(){var e,t,n,o;return o=Object.prototype.hasOwnProperty,n=!{toString:null}.propertyIsEnumerable("toString"),e=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],t=e.length,function(t){var r,i,a,u,p,l;if(typeof t!="object"&&typeof t!="function"||t===null)throw new TypeError("Object.keys called on a non-object");u=[];for(i in t)a=t[i],o.call(t,i)&&u.push(i);if(n)for(p=0,l=e.length;l>p;p++)r=e[p],o.call(t,r)&&u.push(r);return u}}(),(r=this.process)==null&&(this.process={}),this.process.nextTick||(this.process.nextTick=function(e){return setTimeout(e,0)}),t=function(){function t(e){var o,r,i,a,u,p;n=this,e==null&&(e={}),(o=e.maxSize)==null&&(e.maxSize=0),(r=e.maxCount)==null&&(e.maxCount=0),(i=e.maxAge)==null&&(e.maxAge=0),(a=e.deathTime)==null&&(e.deathTime=0),(u=e.pruneTime)==null&&(e.pruneTime=5),(p=e.debug)==null&&(e.debug=!1),n.maxSize=e.maxSize,n.maxCount=e.maxCount,n.maxAge=e.maxAge,n.debug=e.debug,n.pruneTime=e.pruneTime*1e3,n.deathTime=e.deathTime,function(e){return t.prototype.prune.call(e)}(n)}var n;return t.prototype.heap={},t.prototype.maxSize=0,t.prototype.maxCount=0,t.prototype.maxAge=0,t.prototype.pruneTime=5,t.prototype.deathTime=0,t.prototype.debug=!1,n=t,t.prototype.set=function(t,o,r,i){var a,u,p;return r==null&&(r={}),(u=r.maxAge)==null&&(r.maxAge=n.maxAge),(p=r.deathTime)==null&&(r.deathTime=n.deathTime),a=new e(t,o,r),n.heap[t]=a,i(null,a.data)},t.prototype.get=function(e,t){var o;return n=this,typeof t=="function"?process.nextTick(function(){var o;return o=n.heap[e],o===void 0?t({type:"notfound",message:"Key "+e+" not found in heap."}):o.isGood?t(null,o.data):(n.destroy(e),t({type:"invalid",message:"Key "+e+" is invalid or expired."}))}):(o=n.heap[e],o===void 0?null:o.isGood?o.data:(n.destroy(e),null))},t.prototype.getOrSet=function(e,t,o,r){return n=this,n.get(e,function(i,a){var u;return i?i.type==="notfound"||i.type==="invalid"?(u=r(),n.set(e,u,t,o)):o(i):o(null,a)})},t.prototype.destroy=function(e){return n.debug&&console.log("Destroying key "+e),delete n.heap[e]},t.prototype.prune=function(){var e,o,r,i,a,u,p,l,s,c,m,y,f,d,h,g;clearTimeout(n.timer),u=[],p=0,h=n.heap;for(o in h)r=h[o],r.isGood()||u.push(o);for(s=0,y=u.length;y>s;s++)o=u[s],p++,n.destroy(o);if(n.maxCount!==0&&(e=Object.keys(n.heap).length,e>n.maxCount))for(i=e-n.maxCount,u=Object.keys(n.heap).slice(0,i),c=0,f=u.length;f>c;c++)o=u[c],p++,n.destroy(o);if(n.maxSize!==0&&(l=n.calculateSize(),l>n.maxSize)){a=l-n.maxSize,u=[],g=n.heap;for(o in g)if(r=g[o],u.push(o),a-=r.size,0>=a)break;for(m=0,d=u.length;d>m;m++)o=u[m],p++,n.destroy(o)}return n.timer=setTimeout(function(){return t.prototype.prune.call(n)},n.pruneTime),p},t.prototype.calculateSize=function(){var e,t,o,r;o=0,r=n.heap;for(e in r)t=r[e],o+=t.size;return o},t}(),e=function(){function e(e,n,o){var r,i;if(t=this,e===void 0)throw"Memorable missing key element";if(n===void 0)throw"Memorable missing data element";o==null&&(o={}),(r=o.maxAge)==null&&(o.maxAge=0),(i=o.deathTime)==null&&(o.deathTime=0),t.key=e,t.data=n,o.maxAge!==0&&(t.expires=Date.now()+o.maxAge*1e3),t.deathTime=o.deathTime,t.size=t.calculateSize()}var t;return e.prototype.key="",e.prototype.data={},e.prototype.invalid=!1,e.prototype.size=0,e.prototype.expires=0,e.prototype.deathTime=0,t=e,e.prototype.isGood=function(){return!t.invalid&&(t.expires===0||t.expires>Date.now())},e.prototype.isNearDeath=function(){return Date.now()>t.expires-DeathTime*1e3},e.prototype.invalidate=function(){return t.invalid=!0},e.prototype.calculateSize=function(){var e,n,o,r,i,a,u,p;o=[],a=[t.data],e=0,r=null,i=function(e){return e.__c||!1},n=function(e){return e.__c=!0},u=function(e){return delete e.__c};while(a.length)p=a.pop(),function(t){var r,p;if(typeof t=="string")return e+=t.length*2;if(typeof t=="boolean")return e+=4;if(typeof t=="number")return e+=8;if(typeof t=="object"&&!i(t)){o.push(function(){return u(t)});for(r in t)p=t[r],t.hasOwnProperty(r)&&a.push(p);return n(t)}}(p);while(r=o.pop())r.call();return e},e}(),o=this,n=!1,typeof module!="undefined"&&module.exports&&(module.exports=t),o.ShortMemory=t,o.Memorable=e}).call(this)