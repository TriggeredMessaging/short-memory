/* short-memory; Copyright 2012 Aejay Goehring. Licensed under MIT License; See LICENSE for details. */
(function(){var e,t,n,o;t=function(){function t(e){var o,r,u,a,i,l;n=this,e==null&&(e={}),(o=e.maxSize)==null&&(e.maxSize=0),(r=e.maxCount)==null&&(e.maxCount=0),(u=e.maxAge)==null&&(e.maxAge=0),(a=e.deathTime)==null&&(e.deathTime=0),(i=e.pruneTime)==null&&(e.pruneTime=5),(l=e.debug)==null&&(e.debug=!1),n.maxSize=e.maxSize,n.maxCount=e.maxCount,n.maxAge=e.maxAge,n.debug=e.debug,n.pruneTime=e.pruneTime*1e3,n.deathTime=e.deathTime,function(e){return t.prototype.prune.call(e)}(n)}var n;return t.prototype.heap={},t.prototype.maxSize=0,t.prototype.maxCount=0,t.prototype.maxAge=0,t.prototype.pruneTime=5,t.prototype.deathTime=0,t.prototype.debug=!1,n=t,t.prototype.set=function(e,t,o,r){return typeof o=="function"&&(r=o,o={}),typeof r=="function"?(n.debug&&console.log("Debug: set has a callback; running async"),process.nextTick(function(){var u;return u=n.setInternal(e,t,o),r(u[0],u[1])}),null):(n.debug&&console.log("Debug: get has no callback; running sync"),n.setInternal(e,t,o)[1])},t.prototype.setInternal=function(t,o,r){var u,a,i;try{return r==null&&(r={}),(a=r.maxAge)==null&&(r.maxAge=n.maxAge),(i=r.deathTime)==null&&(r.deathTime=n.deathTime),u=new e(t,o,r),n.heap[t]=u,n.debug&&console.log("Debug: set heap["+t+"] to "+o),[null,u.data]}catch(l){return console.error("Unable to set memorable: "+l),[{type:"exception",message:l},null]}},t.prototype.get=function(e,t){return n=this,typeof t=="function"?(n.debug&&console.log("Debug: get has a callback; running async"),process.nextTick(function(){var o;return o=n.getInternal(e),t(o[0],o[1])}),null):(n.debug&&console.log("Debug: get has no callback; running sync"),n.getInternal(e)[1])},t.prototype.getInternal=function(e){var t;return n.debug&&console.log("Debug: getting key "+e+" from heap"),t=n.heap[e],t===void 0?(n.debug&&console.log("Debug: not found"),[{type:"notfound",message:"Key "+e+" not found in heap."},null]):t.isGood?(n.debug&&console.log("Debug: found it!"),[null,t.data]):(n.debug&&console.log("Debug: expired or invalid"),n.destroy(e),[{type:"notvalid",message:"Key "+e+" expired or invalid."},null])},t.prototype.getOrSet=function(e,t,o,r){var u;if(n=this,typeof o=="function"&&(r=o,o={}),typeof r!="function"){if(n.debug&&console.log("Debug: getOrSet; getting sync"),u=n.getInternal(e),u[0]){if(n.debug&&console.log("Debug: getOrSet; no valid key; setting"),o.async)throw"Cannot call getOrSet async without a callback!";return n.setInternal(e,t(),o)}if(n.heap[e].isNearDeath()){if(n.debug&&console.log("Debug: getOrSet; key is near death; will set after get"),o.async)throw"Cannot call getOrSet async without a callback!";process.nextTick(function(){return n.set(e,t(e,o))})}return u[1]}return n.debug&&console.log("Debug: getOrSet; getting async"),n.get(e,function(u,a){return u?(n.debug&&console.log("Debug: getOrSet; key invalid, setting back"),o.async?(n.debug&&console.log("Debug: getOrSet; setback is async"),t(e,function(t){return n.set(e,t,o,r)})):(n.debug&&console.log("Debug: getOrSet; setback is sync"),n.set(e,t(e),o,r))):(n.debug&&console.log("Debug: getOrSet; key exists, calling back"),r(null,a),n.heap[e].isNearDeath()?(n.debug&&console.log("Debug: getOrSet; key is near death; will set after get"),o.async?process.nextTick(function(){return t(e,function(t){return n.set(e,t,o)})}):process.nextTick(function(){return n.set(e,t(e,o))})):void 0)}),n.get(e,function(u,a){var i;return u?u.type==="notfound"||u.type==="invalid"?(i=t(),n.set(e,i,o,r)):r(u):r(null,a)})},t.prototype.destroy=function(e,t){return typeof t=="function"?process.nextTick(function(){return n.debug&&console.log("Debug: destroying key sync "+e),t(delete n.heap[e])}):(n.debug&&console.log("Debug: destroying key sync "+e),delete n.heap[e])},t.prototype.prune=function(){var e,o,r,u,a,i,l,c,s,g,p,y,d,f,m,h;clearTimeout(n.timer),i=[],l=0,m=n.heap;for(o in m)r=m[o],r.isGood()||i.push(o);for(s=0,y=i.length;y>s;s++)o=i[s],l++,n.destroy(o);if(n.maxCount!==0&&(e=Object.keys(n.heap).length,e>n.maxCount))for(u=e-n.maxCount,i=Object.keys(n.heap).slice(0,u),g=0,d=i.length;d>g;g++)o=i[g],l++,n.destroy(o);if(n.maxSize!==0&&(c=n.calculateSize(),c>n.maxSize)){a=c-n.maxSize,i=[],h=n.heap;for(o in h)if(r=h[o],i.push(o),a-=r.size,0>=a)break;for(p=0,f=i.length;f>p;p++)o=i[p],l++,n.destroy(o)}return n.timer=setTimeout(function(){return t.prototype.prune.call(n)},n.pruneTime),l},t.prototype.calculateSize=function(){var e,t,o,r;o=0,r=n.heap;for(e in r)t=r[e],o+=t.size;return o},t.prototype.isHealthy=function(e){var t;return t=n.heap[e],t?t.isGood()&&!t.isNearDeath():!1},t}(),e=function(){function e(e,n,o){var r,u;if(t=this,e===void 0)throw"Memorable missing key element";if(n===void 0)throw"Memorable missing data element";o==null&&(o={}),(r=o.maxAge)==null&&(o.maxAge=0),(u=o.deathTime)==null&&(o.deathTime=0),t.key=e,t.data=n,o.maxAge!==0&&(t.expires=Date.now()+o.maxAge*1e3),t.deathTime=o.deathTime,t.size=t.calculateSize()}var t;return e.prototype.key="",e.prototype.data={},e.prototype.invalid=!1,e.prototype.size=0,e.prototype.expires=0,e.prototype.deathTime=0,t=e,e.prototype.isGood=function(){return!t.invalid&&(t.expires===0||t.expires>Date.now())},e.prototype.isNearDeath=function(){return Date.now()>t.expires-t.deathTime*1e3},e.prototype.invalidate=function(){return t.invalid=!0},e.prototype.calculateSize=function(){var e,n,o,r,u,a,i,l;o=[],a=[t.data],e=0,r=null,u=function(e){return e.__c||!1},n=function(e){return e.__c=!0},i=function(e){return delete e.__c};while(a.length)l=a.pop(),function(t){var r,l;if(typeof t=="string")return e+=t.length*2;if(typeof t=="boolean")return e+=4;if(typeof t=="number")return e+=8;if(typeof t=="object"&&!u(t)){o.push(function(){return i(t)});for(r in t)l=t[r],t.hasOwnProperty(r)&&a.push(l);return n(t)}}(l);while(r=o.pop())r.call();return e},e}(),o=this,n=!1,typeof module!="undefined"&&module.exports&&(module.exports=t),o.ShortMemory=t,o.Memorable=e}).call(this)