(function(){var e,t,n,r;Object.keys=Object.keys||function(){var e,t,n,r;return r=Object.prototype.hasOwnProperty,n=!{toString:null}.propertyIsEnumerable("toString"),e=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],t=e.length,function(t){var i,s,o,u,a,f;if(typeof t!="object"&&typeof t!="function"||t===null)throw new TypeError("Object.keys called on a non-object");u=[];for(s in t)o=t[s],r.call(t,s)&&u.push(s);if(n)for(a=0,f=e.length;a<f;a++)i=e[a],r.call(t,i)&&u.push(i);return u}}(),t=function(){function n(e){var r,i,s,o,u,a;t=this,e==null&&(e={}),(r=e.maxSize)==null&&(e.maxSize=0),(i=e.maxCount)==null&&(e.maxCount=0),(s=e.maxAge)==null&&(e.maxAge=0),(o=e.deathTime)==null&&(e.deathTime=0),(u=e.pruneTime)==null&&(e.pruneTime=5),(a=e.debug)==null&&(e.debug=!1),t.maxSize=e.maxSize,t.maxCount=e.maxCount,t.maxAge=e.maxAge,t.debug=e.debug,t.pruneTime=e.pruneTime*1e3,t.deathTime=e.deathTime,function(e){return n.prototype.prune.call(e)}(t)}var t;return n.prototype.heap={},n.prototype.Memorable=e,n.prototype.maxSize=0,n.prototype.maxCount=0,n.prototype.maxAge=0,n.prototype.pruneTime=5,n.prototype.deathTime=0,n.prototype.debug=!1,t=n,n.prototype.set=function(e,n,r,i){var s,o,u;return r==null&&(r={}),(o=r.maxAge)==null&&(r.maxAge=t.maxAge),(u=r.deathTime)==null&&(r.deathTime=t.deathTime),s=new t.Memorable(e,n,r),t.heap[e]=s,i(null,s.data)},n.prototype.get=function(e,n){return t=this,process.nextTick(function(){var r;return r=t.heap[e],typeof r=="undefined"?n({type:"notfound",message:"Key "+e+" not found in heap."}):r.isGood?n(null,r.data):(t.destroy(e),n({type:"invalid",message:"Key "+e+" is invalid or expired."}))})},n.prototype.getOrSet=function(e,n,r,i){return t=this,t.get(e,function(s,o){var u;return s?s.type==="notfound"||s.type==="invalid"?(u=i(),t.set(e,u,n,r)):r(s):r(null,o)})},n.prototype.destroy=function(e){return t.debug&&console.log("Destroying key "+e),delete t.heap[e]},n.prototype.prune=function(){var e,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;clearTimeout(t.timer),u=[],a=0,m=t.heap;for(r in m)i=m[r],i.isGood()||u.push(r);for(l=0,p=u.length;l<p;l++)r=u[l],a++,t.destroy(r);if(t.maxCount!==0){e=Object.keys(t.heap).length;if(e>t.maxCount){s=e-t.maxCount,u=Object.keys(t.heap).slice(0,s);for(c=0,d=u.length;c<d;c++)r=u[c],a++,t.destroy(r)}}if(t.maxSize!==0){f=t.calculateSize();if(f>t.maxSize){o=f-t.maxSize,u=[],g=t.heap;for(r in g){i=g[r],u.push(r),o-=i.size;if(o<=0)break}for(h=0,v=u.length;h<v;h++)r=u[h],a++,t.destroy(r)}}return t.timer=setTimeout(function(){return n.prototype.prune.call(t)},t.pruneTime),a},n.prototype.calculateSize=function(){var e,n,r,i;r=0,i=t.heap;for(e in i)n=i[e],r+=n.size;return r},n}(),e=function(){function t(t,n,r){var i,s;e=this;if(typeof t=="undefined")throw"Memorable missing key element";if(typeof n=="undefined")throw"Memorable missing data element";r==null&&(r={}),(i=r.maxAge)==null&&(r.maxAge=0),(s=r.deathTime)==null&&(r.deathTime=0),e.key=t,e.data=n,r.maxAge!==0&&(e.expires=Date.now()+r.maxAge*1e3),e.deathTime=r.deathTime,e.size=e.calculateSize()}var e;return t.prototype.key="",t.prototype.data={},t.prototype.invalid=!1,t.prototype.size=0,t.prototype.expires=0,t.prototype.deathTime=0,e=t,t.prototype.isGood=function(){return!e.invalid&&(e.expires===0||Date.now()<e.expires)},t.prototype.isNearDeath=function(){return Date.now()>e.expires-DeathTime*1e3},t.prototype.invalidate=function(){return e.invalid=!0},t.prototype.calculateSize=function(){var t,n,r,i,s,o,u,a;r=[],o=[e.data],t=0,i=null,s=function(e){return e.__c||!1},n=function(e){return e.__c=!0},u=function(e){return delete e.__c};while(o.length)a=o.pop(),function(e){var i,a;if(typeof e=="string")return t+=e.length*2;if(typeof e=="boolean")return t+=4;if(typeof e=="number")return t+=8;if(typeof e=="object"&&!s(e)){r.push(function(){return u(e)});for(i in e)a=e[i],e.hasOwnProperty(i)&&o.push(a);return n(e)}}(a);while(i=r.pop())i.call();return t},t}(),r=this,n=!1,typeof module!="undefined"&&module.exports&&(module.exports=t),r.ShortMemory=t,r.Memorable=e}).call(this)