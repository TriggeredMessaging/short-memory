(function(){var e,t,n,r;Object.keys=object.keys||function(){var e,t,n,r;return r=Object.prototype.hasOwnProperty,n=!{toString:null}.propertyIsEnumerable("toString"),e=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],t=e.length,function(t){var i,s,o,u,a,f;if(typeof t!="object"&&typeof t!="function"||t===null)throw new TypeError("Object.keys called on a non-object");u=[];for(s in t)o=t[s],r.call(t,s)&&u.push(s);if(n)for(a=0,f=e.length;a<f;a++)i=e[a],r.call(t,i)&&u.push(i);return u}}(),t=function(){function t(e){var n,r,i,s,o,u,a;e==null&&(e={}),(n=e.maxSize)==null&&(e.maxSize=0),(r=e.maxCount)==null&&(e.maxCount=0),(i=e.maxAge)==null&&(e.maxAge=0),(s=e.deathTime)==null&&(e.deathTime=0),(o=e.pruneTime)==null&&(e.pruneTime=5),(u=e.debug)==null&&(e.debug=!1),this.maxSize=e.maxSize,this.maxCount=e.maxCount,this.maxAge=e.maxAge,this.debug=e.debug,this.pruneTime=e.pruneTime*1e3,this.deathTime=e.deathTime,a=this,function(e){return t.prototype.prune.call(e)}(a)}return t.prototype.heap={},t.prototype.Memorable=e,t.prototype.maxSize=0,t.prototype.maxCount=0,t.prototype.maxAge=0,t.prototype.pruneTime=5,t.prototype.deathTime=0,t.prototype.debug=!1,t.prototype.set=function(e,t,n,r){var i,s,o;return n==null&&(n={}),(s=n.maxAge)==null&&(n.maxAge=this.maxAge),(o=n.deathTime)==null&&(n.deathTime=this.deathTime),i=new this.Memorable(e,t,n),this.heap[e]=i,r(null,i.data)},t.prototype.get=function(e,t){var n;return n=this,process.nextTick(function(){var r;return r=n.heap[e],typeof r=="undefined"?t({type:"notfound",message:"Key "+e+" not found in heap."}):r.isGood?t(null,r.data):(this.destroy(e),t({type:"invalid",message:"Key "+e+" is invalid or expired."}))})},t.prototype.getOrSet=function(e,t,n,r){var i;return i=this,this.get(e,function(s,o){var u;return s?s.type==="notfound"||s.type==="invalid"?(u=r(),i.set(e,u,t,n)):n(s):n(null,o)})},t.prototype.destroy=function(e){return this.debug&&console.log("Destroying key "+e),delete this.heap[e]},t.prototype.prune=function(){var e,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;clearTimeout(this.timer),o=[],u=0,v=this.heap;for(n in v)r=v[n],r.isGood()||o.push(n);for(f=0,h=o.length;f<h;f++)n=o[f],u++,this.destroy(n);if(this.maxCount!==0){e=Object.keys(this.heap).length;if(e>this.maxCount){i=e-this.maxCount,o=Object.keys(this.heap).slice(0,i);for(l=0,p=o.length;l<p;l++)n=o[l],u++,this.destroy(n)}}if(this.maxSize!==0){a=this.calculateSize();if(a>this.maxSize){s=a-this.maxSize,o=[],m=this.heap;for(n in m){r=m[n],o.push(n),s-=r.size;if(s<=0)break}for(c=0,d=o.length;c<d;c++)n=o[c],u++,this.destroy(n)}}return g=this,this.timer=setTimeout(function(e){return t.prototype.prune.call(e)},this.pruneTime,g),u},t.prototype.calculateSize=function(){var e,t,n,r;n=0,r=this.heap;for(e in r)t=r[e],n+=t.size;return n},t}(),e=function(){function e(e,t,n){var r,i;if(typeof e=="undefined")throw"Memorable missing key element";if(typeof t=="undefined")throw"Memorable missing data element";n==null&&(n={}),(r=n.maxAge)==null&&(n.maxAge=0),(i=n.deathTime)==null&&(n.deathTime=0),this.key=e,this.data=t,n.maxAge!==0&&(this.expires=Date.now()+n.maxAge*1e3),this.deathTime=n.deathTime,this.size=this.calculateSize()}return e.prototype.key="",e.prototype.data={},e.prototype.invalid=!1,e.prototype.size=0,e.prototype.expires=0,e.prototype.deathTime=0,e.prototype.isGood=function(){return!this.invalid&&(this.expires===0||Date.now()<this.expires)},e.prototype.isNearDeath=function(){return Date.now()>this.expires-DeathTime*1e3},e.prototype.invalidate=function(){return this.invalid=!0},e.prototype.calculateSize=function(){var e,t,n,r,i,s,o,u;n=[],s=[this.data],e=0,r=null,i=function(e){return e.__c||!1},t=function(e){return e.__c=!0},o=function(e){return delete e.__c};while(s.length)u=s.pop(),function(r){var u,a;if(typeof r=="string")return e+=r.length*2;if(typeof r=="boolean")return e+=4;if(typeof r=="number")return e+=8;if(typeof r=="object"&&!i(r)){n.push(function(){return o(r)});for(u in r)a=r[u],r.hasOwnProperty(u)&&s.push(a);return t(r)}}(u);while(r=n.pop())r.call();return e},e}(),r=this,n=!1,typeof module!="undefined"&&module.exports&&(module.exports=t),r.ShortMemory=t,r.Memorable=e}).call(this)